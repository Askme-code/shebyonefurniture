{
  "entities": {
    "Product": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Product",
      "type": "object",
      "description": "Represents a furniture product in the Shaaban Furniture catalog.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Product entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the product."
        },
        "price": {
          "type": "number",
          "description": "The price of the product."
        },
        "description": {
          "type": "string",
          "description": "A detailed description of the product."
        },
        "category": {
          "type": "string",
          "description": "The category the product belongs to (e.g., Beds, Sofas, Chairs)."
        },
        "images": {
          "type": "array",
          "description": "An array of URLs pointing to the product's images in Firebase Storage.",
          "items": {
            "type": "string"
          }
        },
        "stock": {
          "type": "number",
          "description": "The number of units of the product currently in stock."
        },
        "featured": {
          "type": "boolean",
          "description": "Indicates whether the product is featured or not."
        },
        "createdAt": {
          "type": "string",
          "description": "The date and time when the product was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "price",
        "description",
        "category",
        "images",
        "stock",
        "featured",
        "createdAt"
      ]
    },
    "Order": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Order",
      "type": "object",
      "description": "Represents a customer order.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Order entity."
        },
        "customerName": {
          "type": "string",
          "description": "The name of the customer who placed the order."
        },
        "phone": {
          "type": "string",
          "description": "The customer's phone number."
        },
        "address": {
          "type": "string",
          "description": "The customer's shipping address."
        },
        "items": {
          "type": "array",
          "description": "An array of product IDs and quantities in the order.",
          "items": {
            "type": "string"
          }
        },
        "total": {
          "type": "number",
          "description": "The total price of the order."
        },
        "status": {
          "type": "string",
          "description": "The status of the order (e.g., Pending, Processing, Delivered)."
        },
        "createdAt": {
          "type": "string",
          "description": "The date and time when the order was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "customerName",
        "phone",
        "address",
        "items",
        "total",
        "status",
        "createdAt"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the Shaaban Furniture platform.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "role": {
          "type": "string",
          "description": "The user's role (e.g., admin, customer)."
        },
        "styleProfile": {
          "type": "string",
          "description": "Style profile of the user. Used for personalized recommendations."
        }
      },
      "required": [
        "id",
        "role"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous",
      "google.com"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/products/{productId}",
        "definition": {
          "entityName": "Product",
          "schema": {
            "$ref": "#/backend/entities/Product"
          },
          "description": "Stores product information. Anyone can view products. Only admins can create, edit, or delete products.",
          "params": [
            {
              "name": "productId",
              "description": "Unique identifier for the product."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user information, including the user's role. This collection is used for authentication and authorization.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/orders/{orderId}",
        "definition": {
          "entityName": "Order",
          "schema": {
            "$ref": "#/backend/entities/Order"
          },
          "description": "Stores orders associated with a specific user. Customers can only see their own orders. Admins can view all orders. Includes denormalized 'userId' for authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "Unique identifier for the user."
            },
            {
              "name": "orderId",
              "description": "Unique identifier for the order."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{uid}",
        "definition": {
          "entityName": "role",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Collection to denote admin roles. Document existence signifies admin status.",
          "params": [
            {
              "name": "uid",
              "description": "User ID of the admin."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to ensure security, scalability, and ease of debugging, while adhering to the principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), and QAPs (Rules are not Filters). It incorporates denormalization for authorization, structural segregation for homogenous security posture, and standardized access modeling.\n\n1.  **Authorization Independence (Denormalization):** The `orders` subcollection within each user document includes denormalized `userId` field. This allows security rules to validate order ownership without requiring `get()` calls to parent documents.\n2.  **Clarity of Intent:** The structure clearly separates user-owned data (`/users/{userId}/orders/{orderId}`) from globally accessible data (`/products/{productId}`). This separation makes the access rules more intuitive and easier to manage.\n3.  **DBAC (Database-Based Access Control):** User roles (admin/customer) are stored directly in the `/users/{userId}` document. This avoids the need for custom claims, simplifying the authentication process and security rules.\n4.  **QAPs (Rules are not Filters):** The structure enables secure `list` operations. Products can be listed publicly without requiring filtering on the client-side. Admin-only access to all orders is enforced by path-based rules and role checks.\n\n**Specific Implementation Details:**\n\n*   **/products/{productId}:** Stores product information. Anyone can view products. Only admins can create, edit, or delete products.\n*   **/users/{userId}:** Stores user information, including the user's role. This collection is used for authentication and authorization.\n*   **/users/{userId}/orders/{orderId}:** Stores orders associated with a specific user. Customers can only see their own orders. Admins can view all orders.\n*   **/roles_admin/{uid}:** Dedicated collection to denote admin roles by document existence.\n\n**Denormalization Strategy:**\n\nThe `/users/{userId}/orders/{orderId}` path denormalizes the userId into the order document, thus making it possible to validate the user id against request.auth.uid during order creation and retrieval, without having to refer to any parent document using get(). This eliminates hierarchical authorization dependencies, allowing atomic operations and improved security rule debuggability."
  }
}